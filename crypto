import requests
import telebot
import time
import threading
import schedule

TOKEN = "**********************"
CHAT_ID = "**********"
THRESHOLD = 0.01
COINS = ['ethereum', 'bitcoin', 'solana', 'binancecoin', 'cardano', 'ripple']
last_prices = {coin: None for coin in COINS}

bot = telebot.TeleBot(TOKEN)

def get_prices():
    """Fetches current prices and 24h percentage change"""
    ids = ",".join(COINS)
    url = f"https://api.coingecko.com/api/v3/simple/price?ids={ids}&vs_currencies=eur&include_24hr_change=true"
    response = requests.get(url)
    return response.json()

@bot.message_handler(commands=['help', 'start'])
def send_help(message):
    help_text = (
        "ðŸ¤– **Crypto Analyst Bot Commands:**\n\n"
        "ðŸ“ˆ `/status` - Show current prices for all coins\n"
        "ðŸ† `/top` - Rank coins by 24h performance\n"
        "â° *Daily Summary* - Sent automatically at 08:00\n"
        "ðŸ“¢ *Alerts* - I'll notify you if a coin moves > 1%"
    )
    bot.reply_to(message, help_text, parse_mode="Markdown")

@bot.message_handler(commands=['top'])
def send_top(message):
    try:
        data = get_prices()
        # Sort coins by the 24h change percentage (descending)
        sorted_coins = sorted(
            COINS,
            key=lambda x: data[x].get('eur_24h_change', 0),
            reverse=True
        )

        text = "ðŸ† **24h Performance Ranking:**\n\n"
        for i, coin in enumerate(sorted_coins, 1):
            change = round(data[coin]['eur_24h_change'], 2)
            emoji = "ðŸ¥‡" if i == 1 else "ðŸ¥ˆ" if i == 2 else "ðŸ¥‰" if i == 3 else "ðŸ”¹"
            text += f"{emoji} {coin.capitalize()}: {change}%\n"

        bot.reply_to(message, text, parse_mode="Markdown")
    except Exception as e:
        print(f"Error fetching data: {e}")
        bot.reply_to(message, "âŒ Could not rank coins right now.")

# ... [Keep your existing send_daily_summary, run_scheduler, and price_tracker functions here] ...

def send_daily_summary():
    """Function to send a report once a day"""
    try:
        data = get_prices()
        summary = "â˜• **Good Morning! Your Daily Crypto Report:**\n\n"
        for coin in COINS:
            price = data[coin]['eur']
            change_24h = round(data[coin]['eur_24h_change'], 2)
            emoji = "ðŸŸ¢" if change_24h > 0 else "ðŸ”´"
            summary += f"{emoji} {coin.capitalize()}: {price} EUR ({change_24h}% 24h)\n"

        bot.send_message(CHAT_ID, summary, parse_mode="Markdown")
        print("Daily summary sent!")
    except Exception as e:
        print(f"Error sending summary: {e}")

def run_scheduler():
    """Background thread for the clock"""
    # Change '08:00' to whatever time you want the report
    schedule.every().day.at("08:00").do(send_daily_summary)

    while True:
        schedule.run_pending()
        time.sleep(60)

def price_tracker():
    print("Multi-coin analyst started...")
    while True:
        try:
            data = get_prices()
            for coin in COINS:
                current_price = data[coin]['eur']
                if last_prices[coin] is None:
                    last_prices[coin] = current_price
                    continue

                change = (current_price - last_prices[coin]) / last_prices[coin]

                if abs(change) >= THRESHOLD:
                    direction = "ðŸ“ˆ" if change > 0 else "ðŸ“‰"
                    percent = round(change * 100, 2)
                    msg = f"{direction} **{coin.upper()}** {percent}%\nPrice: {current_price} EUR"
                    bot.send_message(CHAT_ID, msg, parse_mode="Markdown")
                    last_prices[coin] = current_price

            time.sleep(600)
        except Exception as e:
            print(f"Tracker Error: {e}")
            time.sleep(60)

@bot.message_handler(commands=['status'])
def send_status(message):
    try:
        data = get_prices()
        text = "ðŸ“Š **Current Prices:**\n"
        for coin in COINS:
            p = data[coin]['eur']
            text += f"â€¢ {coin.capitalize()}: {p} EUR\n"
        bot.reply_to(message, text, parse_mode="Markdown")
    except Exception as e:
        print(f"Error fetching data: {e}")
        bot.reply_to(message, "Error fetching data.")

if __name__ == "__main__":
    threading.Thread(target=run_scheduler, daemon=True).start()
    threading.Thread(target=price_tracker, daemon=True).start()
    print("All systems running with /top command active...")
    bot.infinity_polling()
